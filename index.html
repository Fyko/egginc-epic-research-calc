<html>
<head>
	<meta charset="UTF-8">
	<title>Egg, Inc. Golden Egg Costs Calculator</title>

	<script src="underscore-min.js"></script>

</head>
<body>
	<div id="content"></div>
	<!-- Style (or lack thereof) -->
	<style>
		@font-face {
			font-family: Always Together;
			src: url("Always Together.otf");
		}
		#content {
			max-width: 860px;
			margin: 0 auto;
		}
		body {
			font-family: Always Together;
			background-color: rgb(191, 191, 191);
			cursor: default;
		}
		.modal {
			background-color: white;
			border-radius: 25px;
			padding-bottom: 15px;
			margin-bottom: 25px;
		}
		.left {
			float: left;
		}
		.right {
			float: right;
		}
		.clear {
			clear: both;
		}
		input, select, textarea, button {
			font-family: inherit;
		}
		h1 {
			text-align: center;
			font-weight: lighter;
			color: black;
		}
		h2 {
			text-align: center;
			font-weight: lighter;
			color: white;
			margin: 0 0 15px 0;
			padding: 5px;
			border-top-left-radius: 25px;
			border-top-right-radius: 25px;
			background-color: rgb(39, 110, 198);
		}
		h3 {
			text-align: center;
			font-weight: lighter;
			color: black;
			margin: 0;
		}
		table {
			width: 100%;
			border-collapse: collapse;
			text-align: center;
			font-size: 18px;
		}
		td, th {
			padding: 5px;
		}
		.odd td, th {
			background-color: #e5e5e5;
		}
		.noborder {
			border: none;
		}
		.noselect {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		.inline {
			display: inline-block;
		}
		table input[type='number'] {
			width: 40px;
		}
		input[type='checkbox'] {
			margin-left: 25px;
		}

		.innercontent {
			padding: 0 15px 0 15px;
		}
		.innercontent textarea {
			font-family: monospace;
			font-size: 11px;
			width: 100%;
			margin-bottom: 2px;
		}
		.buttonrow {
			height: 40px;
		}
		.buttonrow button {
			font-size: 18px;
		}

		.padright {
			margin-right: 25px;
		}
		.padleft {
			margin-left: 25px;
		}
		.padbottom {
			margin-bottom: 14px;
		}

		.bold-text {
			font-weight: bold;
		}

		.showdesc { display: table-cell; }
		.showbonus { display: table-cell; }
		.showspent { display: table-cell; }
		.showremaining { display: table-cell; }
		.showtotal { display: table-cell; }

		tr.hide { display: none; }
		.showdesc.hide { display: none; }
		.showbonus.hide { display: none; }
		.showspent.hide { display: none; }
		.showremaining.hide { display: none; }
		.showtotal.hide { display: none; }

		#exportfield {
			resize: vertical;
		}

		button {
			cursor: pointer;
			font-size: 16px;
			color: white;
			background-color: #19AD01;
			border-radius: 5px;
			padding: 2px 15px;
			margin: 0px 3px;
			border: 0;
		}

		button:active {
			opacity: 0.6;
		}

		button[disabled] {
			background-color: #7F7F7F;
		}
	</style>

	<!-- Firefox, please -->
	<style type="text/css">
		@-moz-document url-prefix() {
			button {
				margin-top:-1px;
			}
		}
	</style>

	<!-- Template -->
	<script type="text/template" class="template">
		<h1>Egg, Inc. Golden Eggs Costs Calculator</h1>
		<div class="modal">
			<h2>Current Statistics</h2>
			<table id="stats-table">
				<tr>
					<th>Name</th>
					<th class="showdesc">Description</th>
					<th class="showbonus">Bonus</th>
					<th>Level</th>
					<th class="showspent">Spent</th>
					<th class="showremaining">Remaining</th>
					<th class="showtotal">Total Cost</th>
				</tr>
				<%	var tabindex = 0;
					_.each( upgrades, function( upgrade, key ) {
						tabindex++; %>
					<tr id="upgradeRow-<%- key %>">
						<td><%- upgrade.title %></td>
						<td class="showdesc"><%- upgrade.desc %></td>
						<td class="showbonus" style="width: 86px"id="bonus-<%- key %>">-</td>
						<td style="width: 82px"><div class="noselect inline"><input type="number" min="0" max="<%- upgrade.costs.length %>" id="lvl-<%- key %>" tabindex="<%- 10+tabindex %>"></div> / <%- upgrade.costs.length %></td>
						<td class="showspent" style="width: 58px" id="spent-<%- key %>">-</td>
						<td class="showremaining" style="width: 58px" id="remaining-<%- key %>">-</td>
						<td class="showtotal" style="width: 58px" ><%- upgrade.total.toLocaleString() %></td>
					</tr>
				<% }); %>
				<tr class="bold-text">
					<td class="noborder"></th>
					<td class="noborder showdesc"></th>
					<td class="noborder showbonus"></th>
					<td id="total-levels"><%- totals.levels %></th>
					<td id="total-spent" class="showspent"><%- totals.cost %></th>
					<td id="total-remaining" class="showremaining"><%- totals.levels %></th>
					<td class="showtotal"><%- totals.cost.toLocaleString() %></th>
				</tr>
			</table>
			<label class="noselect"><input type="checkbox" checked="true" id="chkdesc" tabindex="40"> Show Description</label>
			<label class="noselect"><input type="checkbox" checked="true" id="chkbonus" tabindex="41"> Show Bonus</label>
			<label class="noselect"><input type="checkbox" checked="true" id="chkspent" tabindex="42"> Show Spent</label>
			<label class="noselect"><input type="checkbox" checked="true" id="chkremaining" tabindex="43"> Show Remaining</label>
			<label class="noselect"><input type="checkbox" checked="true" id="chktotal" tabindex="44"> Show Total</label>
			<label class="noselect"><input type="checkbox" checked="false" id="sethidecompleted" tabindex="45"> Hide Completed</label>
		</div>

		<div class="modal">
			<h2>Future Planning</h2>
			<div class="padright padleft">
				<div class="noselect inline left">Piggy Bank <input type="number" min="0" id="piggybank" tabindex="50"></div>
				<div class="noselect inline left padleft padbottom">Piggy Level <input type="number" min="1" id="piggylevel" tabindex="51"style="width: 38px"> +<span id="piggybonus">0</span>%</div>
				<div class="noselect inline left" style="margin-left: 4px">(+<span id="piggybonuscalc">0</span>)</div>

				<button class="right" id="crackpiggy" onclick="crackThePiggy()" tabindex="54">Crack Open (+<span id="piggycracktotal">0</span>)</button>
				<div class="noselect inline right padbottom">Golden Eggs <input type="number" min="0" id="goldeneggs" tabindex="53"></div>
			</div>
			<table id="future-table">
				<tr>
					<th>Name</th>
					<th>Level</th>
					<th>Desired Increase</th>
					<th>Cost</th>
					<th>Next Price</th>
					<th>Buy?</th>
				</tr>
				<%	var tabindex = 0;
					_.each( upgrades, function( upgrade, key ) {
						tabindex++; %>
					<tr id="planRow-<%- key %>">
						<td><%- upgrade.title %></td>
						<td style="width: 82px"><div class="noselect inline"><input type="number" min="0" max="<%- upgrade.costs.length %>" id="fut-lvl-<%- key %>" tabindex="<%- 100+tabindex %>"></div> / <%- upgrade.costs.length %></td>
						<td style="width: 100px"><div class="noselect inline"><input type="number" min="0" max="<%- upgrade.costs.length %>" id="fut-inc-<%- key %>" tabindex="<%- 200+tabindex %>"></div></td>
						<td style="width: 82px" id="fut-cost-<%- key %>"></td>
						<td style="width: 82px" id="fut-next-<%- key %>"></td>
						<td><button id="fut-buy-<%- key %>" onclick="buy('<%- key %>')" tabindex="<%- 300+tabindex %>">Buy!</button></td>
					</tr>
				<% }); %>
			</table>
			<div class="innercontent" style="margin-top: 20px;">
				<div class="noselect inline right">Epic % Discount <input type="number" min="0" max="100" id="epicdiscount" tabindex="52"style="width: 38px"></div>
			</div>
			<div class="innercontent clear" style="margin-bottom: 20px;">
				<div class="left">Desired Upgrade Cost: <b id="fut-upgrade-total"></b></div>
				<div class="right padleft">Cost (Truckloads): <b id="fut-egg-remain-cost"></b></div>
				<div class="right">Eggs Left to Obtain: <b id="fut-egg-remain"></b></div>
				<div class="clear"></div>
				<div class="left">Eggs Left to get: <b id="fut-upgrade-remain"></b></div>
				<div class="right padleft">Cost (Truckloads): <b id="fut-egg-remain-piggy-cost"></b></div>
				<div class="right">Eggs Left to Obtain (incl. Piggy Bank): <b id="fut-egg-remain-piggy"></b></div>
			</div>
		</div>

		<div class="modal">
			<h2>Import/Export</h2>
			<div class="innercontent">
				<textarea id="exportfield" rows="8" tabindex="400"></textarea>
				<div class="buttonrow">
					<button onclick="loadBase64()" class="left" tabindex="401">Load from Textfield</button>
					<button onclick="exportBase64()" class="left" tabindex="402">Export to Textfield</button>
					<button onclick="reset()" class="right" tabindex="403">Clear All Data</button>
				</div>
			</div>
		</div>

		<h3>Current as of Egg, Inc. version 1.9</h3>
		<h3><a target="_blank", href="https://www.reddit.com/r/EggsInc/comments/87klhc/epic_research_costs_calculator_updated_for_17/">Click here</a> for discussion, suggestions, and feedback!</h3>
		<h3>Join me on any contracts with 'royalphysique' if you like!</h3>
		<h3><a target="_blank", href="https://github.com/SticklyMan/egginc-epic-research-calc/">It's on GitHub for some reason!</a></h3>
	</script>


	<!-- Javascript -->
	<script>
	// Initial userData
	var initialUserData = {
		eggs: 0,
		piggyLevel: 1,
		piggyBank: 0,
		epicDiscount: 0,
		hideCompleted: false,
		columns: {
			desc: true,
			bonus: true,
			spent: true,
			remaining: true,
			total: true
		},
		upgrades: {
			holdToHatch: 0,
			epicHatchery: 0,
			epicIntHatchery: 0,
			videoDoubler: 0,
			epicClucking: 0,
			epicMultiplier: 0,
			cheaperContractors: 0,
			bustUnions: 0,
			labUpgrade: 0,
			siloCapacity: 0,
			internalHatcherySharing: 0,
			internalHatcheryCalm: 0,
			accountingTricks: 0,
			soulFood: 0,
			prestigeBonus: 0,
			droneRewards: 0,
			epicComfyNests: 0,
			transportationLobbyists: 0,
			warpShift: 0,
			prophecyBonus: 0,
			holdToResearch: 0,
			hyperloopStation: 0
		},
		increase: {
			holdToHatch: 0,
			epicHatchery: 0,
			epicIntHatchery: 0,
			videoDoubler: 0,
			epicClucking: 0,
			epicMultiplier: 0,
			cheaperContractors: 0,
			bustUnions: 0,
			labUpgrade: 0,
			siloCapacity: 0,
			internalHatcherySharing: 0,
			internalHatcheryCalm: 0,
			accountingTricks: 0,
			soulFood: 0,
			prestigeBonus: 0,
			droneRewards: 0,
			epicComfyNests: 0,
			transportationLobbyists: 0,
			warpShift: 0,
			prophecyBonus: 0,
			holdToResearch: 0,
			hyperloopStation: 0
		}
	};
	if (localStorage.userData === undefined) {
		localStorage.userData = JSON.stringify(initialUserData);
	}


	// Upgrade Data
	var upgrades = {
		holdToHatch: {
			costs: [10, 45, 80, 115, 150, 185, 220, 255, 290, 325, 360, 395, 430, 465, 500],
			title: "Hold to Hatch",
			desc: "Hold chicken button +2 chickens per second",
			bonusDesc: "+{VAL}/SEC",
			bonusVal: 2
		},
		epicHatchery: {
			costs: [2, 54, 107, 159, 212, 264, 317, 369, 422, 474, 527, 579, 632, 684, 737, 789, 842, 894, 947, 1000],
			title: "Epic Hatchery",
			desc: "Increase hatchery refill rate by 10%",
			bonusDesc: "+{VAL}%",
			bonusVal: 10
		},
		epicIntHatchery: {
			costs: [25, 155, 285, 415, 546, 676, 806, 936, 1067, 1197, 1327, 1457, 1588, 1718, 1848, 1978, 2109, 2239, 2369, 2500],
			title: "Epic Int. Hatcheries",
			desc: "Increase internal hatchery rate by 5%",
			bonusDesc: "+{VAL}%",
			bonusVal: 5
		},
		videoDoubler: {
			costs: [25, 250, 475, 700, 925, 1150, 1375, 1600, 1825, 2050, 2275, 2500],
			title: "Video Doubler Time",
			desc: "Increase video doubler time by 30 min.",
			bonusDesc: "+{VAL} min.",
			bonusVal: 30
		},
		epicClucking: {
			costs: [20, 282, 544, 806, 1068, 1330, 1592, 1854, 2116, 2378, 2641, 2903, 3165, 3427, 3689, 3951, 4213, 4475, 4737, 5000],
			title: "Epic Clucking",
			desc: "+0.1% egg value bonus for each running chicken",
			bonusDesc: "+{VAL}% / chicken",
			bonusVal: 0.1
		},
		epicMultiplier: {
			costs: [10, 60, 110, 161, 211, 262, 312, 362, 413, 463, 514, 564, 614, 665, 715, 766, 816, 866, 917, 967, 1018, 1068, 1118, 1169, 1219, 1270, 1320, 1370, 1421, 1471, 1522, 1572, 1622, 1673, 1723, 1774, 1824, 1874, 1925, 1975, 2026, 2076, 2126, 2177, 2227, 2278, 2328, 2378, 2429, 2479, 2530, 2580, 2631, 2681, 2731, 2782, 2832, 2883, 2933, 2983, 3034, 3084, 3135, 3185, 3235, 3286, 3336, 3387, 3437, 3487, 3538, 3588, 3639, 3689, 3739, 3790, 3840, 3891, 3941, 3991, 4042, 4092, 4143, 4193, 4243, 4294, 4344, 4395, 4445, 4495, 4546, 4596, 4647, 4697, 4747, 4798, 4848, 4899, 4949, 5000],
			title: "Epic Multiplier",
			desc: "Increase max running chicken bonus by 1.0x!",
			bonusDesc: "+{VAL}x MAX",
			bonusVal: 1
		},
		cheaperContractors: {
			costs: [20, 240, 460, 680, 900, 1120, 1340, 1560, 1780, 2000],
			title: "Cheaper Contractors",
			desc: "Reduce hen house build costs by 5%",
			bonusDesc: "-{VAL}%",
			bonusVal: 5
		},
		bustUnions: {
			costs: [20, 240, 460, 680, 900, 1120, 1340, 1560, 1780, 2000],
			title: "Bust Unions",
			desc: "Reduce vehicle hire costs by 5%",
			bonusDesc: "-{VAL}%",
			bonusVal: 5
		},
		labUpgrade: {
			costs: [25, 244, 463, 683, 902, 1122, 1341, 1561, 1780, 2000],
			title: "Lab Upgrade",
			desc: "Reduce research costs by 5%",
			bonusDesc: "-{VAL}%",
			bonusVal: 5
		},
		siloCapacity: {
			costs: [500, 526, 552, 578, 605, 631, 657, 684, 710, 736, 763, 789, 815, 842, 868, 894, 921, 947, 973, 1000],
			title: "Silo Capacity",
			desc: "Increase away time per silo by 6 min",
			bonusDesc: "+{VAL} min.",
			bonusVal: 6
		},
		internalHatcherySharing: {
			costs: [250, 500, 750, 1000, 1250, 1500, 1750, 2000, 2250, 2500],
			title: "Internal Hatchery Sharing",
			desc: "Full habs' internal hatcheries send +10% chicks to other habs",
			bonusDesc: "{VAL}% shared",
			bonusVal: 10
		},
		internalHatcheryCalm: {
			costs: [10, 114, 219, 324, 428, 533, 638, 743, 847, 952, 1057, 1162, 1266, 1371, 1476, 1581, 1685, 1790, 1895, 2000],
			title: "Internal Hatchery Calm",
			desc: "Increase internal hatchery rate by 10% while away",
			bonusDesc: "+{VAL}%",
			bonusVal: 10
		},
		accountingTricks: {
			costs: [250, 447, 644, 842, 1039, 1236, 1434, 1631, 1828, 2026, 2223, 2421, 2618, 2815, 3013, 3210, 3407, 3605, 3802, 4000],
			title: "Accounting Tricks",
			desc: "Increase farm valuation by 5%",
			bonusDesc: "+{VAL}%",
			bonusVal: 5
		},
		soulFood: {
			costs: [500, 532, 564, 597, 629, 661, 694, 726, 758, 791, 823, 856, 888, 920, 953, 985, 1017, 1050, 1082, 1115, 1147, 1179, 1212, 1244, 1276, 1309, 1341, 1374, 1406, 1438, 1471, 1503, 1535, 1568, 1600, 1633, 1665, 1697, 1730, 1762, 1794, 1827, 1859, 1892, 1924, 1956, 1989, 2021, 2053, 2086, 2118, 2151, 2183, 2215, 2248, 2280, 2312, 2345, 2377, 2410, 2442, 2474, 2507, 2539, 2571, 2604, 2636, 2669, 2701, 2733, 2766, 2798, 2830, 2863, 2895, 2928, 2960, 2992, 3025, 3057, 3089, 3122, 3154, 3187, 3219, 3251, 3284, 3316, 3348, 3381, 3413, 3446, 3478, 3510, 3543, 3575, 3607, 3640, 3672, 3705, 3737, 3769, 3802, 3834, 3866, 3899, 3931, 3964, 3996, 4028, 4061, 4093, 4125, 4158, 4190, 4223, 4255, 4287, 4320, 4352, 4384, 4417, 4449, 4482, 4514, 4546, 4579, 4611, 4643, 4676, 4708, 4741, 4773, 4805, 4838, 4870, 4902, 4935, 4967, 5000],
			title: "Soul Food",
			desc: "Increase bonus per soul egg by +1%",
			bonusDesc: "+{VAL}%",
			bonusVal: 1
		},
		prestigeBonus: {
			costs: [4000, 4105, 4210, 4315, 4421, 4526, 4631, 4736, 4842, 4947, 5052, 5157, 5263, 5368, 5473, 5578, 5684, 5789, 5894, 6000],
			title: "Prestige Bonus",
			desc: "Earn +10% soul eggs when you prestige",
			bonusDesc: "+{VAL}%",
			bonusVal: 10
		},
		droneRewards: {
			costs: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000],
			title: "Drone Rewards",
			desc: "Increase your chances for bigger drone rewards by 10%",
			bonusDesc: "+{VAL}%",
			bonusVal: 10
		},
		epicComfyNests: {
			costs: [250, 2868, 5486, 8105, 10723, 13342, 15960, 18578, 21197, 23815, 26434, 29052, 31671, 34289, 36907, 39526, 42144, 44763, 47381, 50000],
			title: "Epic Comfy Nests",
			desc: "Increase egg laying rate by 5%",
			bonusDesc: "+{VAL}%",
			bonusVal: 5
		},
		transportationLobbyists: {
			costs: [250, 379, 508, 637, 767, 896, 1025, 1155, 1284, 1413, 1543, 1672, 1801, 1931, 2060, 2189, 2318, 2448, 2577, 2706, 2836, 2965, 3094, 3224, 3353, 3482, 3612, 3741, 3870, 4000],
			title: "Transportation Lobbyists",
			desc: "Increase vehicle capacity by 5%",
			bonusDesc: "+{VAL}%",
			bonusVal: 5
		},
		warpShift: {
			costs: [250, 566, 883, 1200, 1516, 1833, 2150, 2466, 2783, 3100, 3416, 3733, 4050, 4366, 4683, 5000],
			title: "Warp Shift",
			desc: "Increases long warp time by 1 hour.",
			bonusDesc: "+{VAL} hrs",
			bonusVal: 1
		},
		prophecyBonus: {
			costs: [20000, 27500, 35000, 42500, 50000],
			title: "Prophecy Bonus",
			desc: "Increase bonus per egg of prophecy by +1% (compounding)",
			bonusDesc: "+{VAL}%",
			bonusVal: 1
		},
		holdToResearch: {
			costs: [5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000],
			title: "Hold to Research",
			desc: "Increase repetition rate when holding down research button by 25%",
			bonusDesc: "+{VAL}%",
			bonusVal: 25
		},
		hyperloopStation: {
			costs: [25000],
			title: "Hyperloop Train",
			desc: "Purchasing Hyperloop trains requires you to first construct a hyperloop station",
			bonusDesc: "✓",
			bonusVal: 0
		}
	};


	// Data persistence helpers
	function save() {
		localStorage.userData = JSON.stringify(userData);
	}

	function reset() {
		userData = JSON.parse(JSON.stringify(initialUserData));
		save();
		populateInputs();
	}

	function load(firsttime, fromstring) {
		// Should prevent errors when the userData structure has changed compared to the user's localstorage.
		// Also REAL fancy because thanks javascript.
		var localData = JSON.parse(fromstring || localStorage.userData);
		var initialData = JSON.parse(JSON.stringify(initialUserData));

		var localColumns = JSON.parse(JSON.stringify(localData.columns || {}));
		var initialColumns = JSON.parse(JSON.stringify(initialUserData.columns));

		var localUpgrades = JSON.parse(JSON.stringify(localData.upgrades || {}));
		var initialUpgrades = JSON.parse(JSON.stringify(initialUserData.upgrades));

		var localIncrease = JSON.parse(JSON.stringify(localData.increase || {}));
		var initialIncrease = JSON.parse(JSON.stringify(initialUserData.increase));

		userData = _.extend(initialData, localData);
		userData.upgrades = _.extend(initialUpgrades, localUpgrades);
		userData.columns = _.extend(initialColumns, localColumns);
		userData.increase = _.extend(initialIncrease, localIncrease);

		if (!firsttime) {
			populateInputs();
		}
	}

	function exportBase64() {
		var exportfield = document.querySelector("#exportfield");
		exportfield.value = btoa(JSON.stringify(userData));
		exportfield.select();
	}

	function loadBase64() {
		load(false, atob(document.querySelector("#exportfield").value));
	}


	// Helper methods for dynamic data calculations, refreshing UI
	function calculate() {
		var totalSpentLevels = 0;
		var totalSpent = 0;
		var totalDesiredUpgrade = 0;
		_.each(upgrades, function(upgrade, key) {
			// Statistics
			var spent = 0;
			for (i=0; i<=userData.upgrades[key]-1; i++) {
				spent += upgrade.costs[i];
			}
			totalSpentLevels += userData.upgrades[key];
			totalSpent += spent;
			document.querySelector("#spent-"+key).innerHTML = spent.toLocaleString();
			document.querySelector("#remaining-"+key).innerHTML = (upgrade.total - spent).toLocaleString();
			document.querySelector("#bonus-"+key).innerHTML = userData.upgrades[key] == 0 ? "&ndash;" : upgrade.bonusDesc.replace("{VAL}", Math.round((upgrade.bonusVal * userData.upgrades[key]) * 100) / 100);

			// Futures
			var increaseCost = 0;
			for (i=userData.upgrades[key]; i<userData.upgrades[key]+userData.increase[key]; i++) {
				increaseCost += upgrade.costs[i] - Math.floor(upgrade.costs[i] * (userData.epicDiscount/100));
			}
			totalDesiredUpgrade += increaseCost;
			document.querySelector("#fut-cost-"+key).innerHTML = increaseCost == 0 ? "&ndash;" : increaseCost.toLocaleString();
			var nextCost = upgrade.costs[userData.upgrades[key]] - Math.floor(upgrade.costs[userData.upgrades[key]] * (userData.epicDiscount/100));
			document.querySelector("#fut-next-"+key).innerHTML = nextCost ? nextCost.toLocaleString() : "&ndash;";

			// Buy?
			document.querySelector("#fut-buy-"+key).disabled = upgrade.costs.length == userData.upgrades[key] || userData.eggs < nextCost;

			// Visiblity if complete
			var upgradeRow = document.querySelector("#upgradeRow-"+key);
			var planRow = document.querySelector("#planRow-"+key);
			if (userData.hideCompleted && userData.upgrades[key] >= upgrade.costs.length) {
				planRow.classList.add("hide");
				upgradeRow.classList.add("hide");
			}
			else {
				planRow.classList.remove("hide");
				upgradeRow.classList.remove("hide");
			}
		});
		document.querySelector("#total-levels").innerHTML = totalSpentLevels + " / " + totals.levels;
		document.querySelector("#total-spent").innerHTML = totalSpent.toLocaleString();
		document.querySelector("#total-remaining").innerHTML = (totals.cost - totalSpent).toLocaleString();
		document.querySelector("#fut-upgrade-total").innerHTML = totalDesiredUpgrade.toLocaleString();
		document.querySelector("#fut-upgrade-remain").innerHTML = Math.max((totalDesiredUpgrade - userData.eggs), 0).toLocaleString();

		// Piggy Bank calculations
		var piggyBonus = getPiggyBankBonus(userData.piggyLevel);
		var piggyBonusCalc = Math.floor(userData.piggyBank*(piggyBonus/100));
		var piggyCrackTotal = userData.piggyBank + piggyBonusCalc;
		document.querySelector("#piggybonus").innerHTML = piggyBonus;
		document.querySelector("#piggybonuscalc").innerHTML = piggyBonusCalc;
		document.querySelector("#piggycracktotal").innerHTML = piggyCrackTotal;

		document.querySelector("#crackpiggy").disabled = userData.piggyBank < 300;

		// Calculate remaining eggs
		var remain = Math.max((totals.cost - totalSpent - userData.eggs), 0);
		var remainPlusPiggy = Math.max((remain-piggyCrackTotal), 0);
		document.querySelector("#fut-egg-remain").innerHTML = remain.toLocaleString();
		document.querySelector("#fut-egg-remain-cost").innerHTML = "$"+(Math.ceil(remain/6750)*19.99).toLocaleString(undefined, { minimumFractionDigits: 2 });
		document.querySelector("#fut-egg-remain-piggy").innerHTML = remainPlusPiggy.toLocaleString();
		document.querySelector("#fut-egg-remain-piggy-cost").innerHTML = "$"+(Math.ceil(remainPlusPiggy/6750)*19.99).toLocaleString(undefined, { minimumFractionDigits: 2 });

		// Re-stripe tables
		stripeTables();
	}

	function getPiggyBankBonus(level) {
		if (level === 1) {
			return 2
		}
		if (level === 2) {
			return 25
		}
		return 10*(level+1)
	}

	function populateInputs() {
		_.each(upgrades, function(upgrade, key) {
			document.querySelector("#lvl-"+key).value = userData.upgrades[key];
			updateLevel(key, true);
			document.querySelector("#fut-inc-"+key).value = userData.increase[key];
			document.querySelector("#fut-inc-"+key).max = upgrade.costs.length - userData.upgrades[key];
			updateIncrease(key);
		});
		_.each(userData.columns, function(value, key) {
			document.querySelector("#chk"+key).checked = userData.columns[key];
			updateColumn(key, userData.columns[key]);
		});
		document.querySelector("#sethidecompleted").checked = userData.hideCompleted;
		document.querySelector("#goldeneggs").value = userData.eggs;
		document.querySelector("#piggylevel").value = userData.piggyLevel;
		document.querySelector("#piggybank").value = userData.piggyBank;
		document.querySelector("#epicdiscount").value = userData.epicDiscount;
		calculate();
	}

	function buy(key) {
		document.querySelector("#lvl-"+key).value++;
		document.querySelector("#fut-inc-"+key).value--;
		document.querySelector("#goldeneggs").value -= upgrades[key].costs[userData.upgrades[key]] - Math.floor(upgrades[key].costs[userData.upgrades[key]] * (userData.epicDiscount/100));

		userUpdateIncrease(key);
		userUpdateLevel(key, true);
		userUpdateEggs();
	}

	function crackThePiggy() {
		var eggs = document.querySelector("#goldeneggs");
		var level = document.querySelector("#piggylevel");
		var bank = document.querySelector("#piggybank");

		var piggyBonus = getPiggyBankBonus(userData.piggyLevel);
		var piggyBonusCalc = Math.floor(userData.piggyBank*(piggyBonus/100));

		eggs.value = parseInt(eggs.value) + userData.piggyBank + piggyBonusCalc;
		bank.value = 0;
		level.value++;
		userUpdateEggs();
	}

	function userUpdateColumn(key, show) {
		updateColumn(key, show);
		userData.columns[key] = show;
		calculate();
		save();
	}

	function setRowsHidden(value) {
		userData.hideCompleted = value;
		calculate();
		save();
	}

	function updateColumn(key, show) {
		var items = document.querySelectorAll(".show"+key);
		for (var i=0; i<items.length; i++) {
			var item = items[i];
			// One would think I could use classList.toggle with a forced parameter, but IE11 proved me wrong.
			if (show) {
				item.classList.remove("hide");
			}
			else {
				item.classList.add("hide");
			}
		}
	}

	function userUpdateLevel(key, isA) {
		var newVal = updateLevel(key, isA);
		userData.upgrades[key] = newVal;

		document.querySelector("#fut-inc-"+key).max = upgrades[key].costs.length - newVal;
		userUpdateIncrease(key);

		calculate();
		save();
	}

	function updateLevel(key, isA) {
		var inputA = document.querySelector("#lvl-"+key);
		var inputB = document.querySelector("#fut-lvl-"+key);
		var newVal = isA ? (parseInt(inputA.value) || 0) : (parseInt(inputB.value) || 0);
		newVal = Math.min(Math.max(newVal, 0), upgrades[key].costs.length);
		inputA.value = newVal;
		inputB.value = newVal;

		return newVal;
	}

	function userUpdateIncrease(key) {
		var newVal = updateIncrease(key);
		userData.increase[key] = newVal;
		calculate();
		save();
	}

	function updateIncrease(key) {
		var input = document.querySelector("#fut-inc-"+key);
		var newVal = parseInt(input.value) || 0;
		newVal = Math.min(Math.max(newVal, 0), (upgrades[key].costs.length - userData.upgrades[key]));
		input.value = newVal;
		return newVal;
	}

	function userUpdateEggs() {
		var result = updateEggs();
		userData.eggs = result[0];
		userData.piggyBank = result[1];
		userData.piggyLevel = result[2];
		userData.epicDiscount = result[3];
		calculate();
		save();
	}

	function updateEggs() {
		var eggs = document.querySelector("#goldeneggs");
		var bank = document.querySelector("#piggybank");
		var level = document.querySelector("#piggylevel");
		var discount = document.querySelector("#epicdiscount");
		var newEggs = parseInt(eggs.value) || 0;
		var newBank = parseInt(bank.value) || 0;
		var newLevel = parseInt(level.value) || 1;
		var newDiscount = parseInt(discount.value) || 0;
		newEggs = Math.max(newEggs, 0);
		newBank = Math.max(newBank, 0);
		newLevel = Math.max(newLevel, 1);
		newDiscount = Math.min(Math.max(newDiscount, 0), 100);
		eggs.value = newEggs;
		bank.value = newBank;
		level.value = newLevel;
		discount.value = newDiscount;
		return [newEggs, newBank, newLevel, newDiscount];
	}

	function stripeTables() {
		stripeRows(document.querySelectorAll("#stats-table tr:not(.hide)"));
		stripeRows(document.querySelectorAll("#future-table tr:not(.hide)"));
	}

	function stripeRows(rows) {
		for (var i=0; i<rows.length; i++) {
			if (i%2==0) {
				rows[i].classList.add('odd');
			}
			else {
				rows[i].classList.remove('odd');
			}
		};
	}

	// Initialize data
	var totals = {
		cost: 0,
		levels: 0
	};
	_.each(upgrades, function(upgrade, key) {
		upgrade.total = upgrade.costs.reduce(function(prev, cur){ return prev+cur; } );
		totals.cost += upgrade.total;
		totals.levels += upgrade.costs.length;
	});
	load(true);

	// Pre-compile and render template
	var template = _.template(
		document.querySelector("script.template").innerHTML
	);
	document.querySelector("#content").innerHTML = template({
		userData: userData,
		upgrades: upgrades,
		totals: totals
	});

	populateInputs();

	// Set up events
	_.each(upgrades, function(upgrade, key) {
		document.querySelector("#lvl-"+key).addEventListener("change", function() { userUpdateLevel(key, true); });
		document.querySelector("#fut-lvl-"+key).addEventListener("change", function() { userUpdateLevel(key, false); });
		document.querySelector("#fut-inc-"+key).addEventListener("change", function() { userUpdateIncrease(key); });
		document.querySelector("#fut-buy-"+key).addEventListener("change", function() { buy(key); });
	});

	_.each(userData.columns, function(val, key) {
		document.querySelector("#chk"+key).addEventListener("change", function(ev) { userUpdateColumn(key, ev.target.checked); });
	});

	document.querySelector("#sethidecompleted").addEventListener("change", function(ev) { setRowsHidden(ev.target.checked); });

	var exportfield = document.querySelector("#exportfield");
	exportfield.onfocus = function() {
		exportfield.select();
	};

	document.querySelector("#goldeneggs").addEventListener("change", userUpdateEggs );
	document.querySelector("#piggylevel").addEventListener("change", userUpdateEggs );
	document.querySelector("#piggybank").addEventListener("change", userUpdateEggs );
	document.querySelector("#epicdiscount").addEventListener("change", userUpdateEggs );

	</script>
</body>
</html>
